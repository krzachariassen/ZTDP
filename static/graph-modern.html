<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZTDP Platform Graph</title>
  <!-- Modern dependencies -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="graph-modern.css">
  
  <style>
    :root {
      --main-bg: #f8f9fa;
      --panel-bg: #fff;
      --primary: #3B82F6;
      --primary-dark: #2563EB;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --purple: #8B5CF6;
      --info: #06B6D4;
      --gray: #6B7280;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--main-bg);
      color: #111827;
      line-height: 1.5;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }
    
    header {
      background-color: white;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
    }
    
    .logo i {
      margin-right: 0.5rem;
    }
    
    .content {
      display: grid;
      grid-template-columns: 1fr 350px;
      grid-template-rows: 1fr 300px;
      height: calc(100vh - 130px);
      gap: 1px;
    }
    
    #graph {
      height: 100%;
      width: 100%;
      background-color: white;
      position: relative;
      grid-column: 1;
      grid-row: 1;
    }
    
    .panel {
      background: var(--panel-bg);
      padding: 1rem;
      border-left: 1px solid #e5e7eb;
      overflow-y: auto;
      grid-column: 2;
      grid-row: 1;
    }

    .logs-panel {
      background: var(--panel-bg);
      border-top: 1px solid #e5e7eb;
      grid-column: 1 / -1;
      grid-row: 2;
      display: flex;
      flex-direction: column;
    }
    
    .panel-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .panel-tabs {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }
    
    .panel-tab {
      background: none;
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--gray);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .panel-tab:hover {
      background: #f3f4f6;
    }
    
    .panel-tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .panel-tabs {
      display: flex;
      gap: 0.25rem;
      margin-left: auto;
    }
    
    .panel-tab {
      background: none;
      border: none;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: var(--radius);
      color: #6b7280;
    }
    
    .panel-tab:hover {
      background-color: #f3f4f6;
    }
    
    .panel-tab.active {
      background-color: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .node-detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .node-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }
    
    .node-title {
      font-weight: 600;
      font-size: 1rem;
      flex-grow: 1;
    }
    
    .node-kind {
      font-size: 0.8rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }
    
    .detail-section {
      margin-bottom: 1rem;
    }
    
    .section-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }
    
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .detail-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .detail-table td:first-child {
      font-weight: 500;
      width: 40%;
      color: #4b5563;
    }
    
    .detail-value {
      font-family: ui-monospace, monospace;
      font-size: 0.8rem;
      background: #f9fafb;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      z-index: 9999;
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification i {
      margin-right: 10px;
      font-size: 18px;
    }
    
    .notification.info i {
      color: var(--primary);
    }
    
    .notification.success i {
      color: var(--success);
    }
    
    .notification.warning i {
      color: var(--warning);
    }
    
    .notification.error i {
      color: var(--danger);
    }
    
    /* Edge tooltip styling */
    .edge-tooltip {
      background: rgba(255, 255, 255, 0.9) !important;
      color: #1f2937;
      border-radius: 4px;
      font-size: 12px;
      padding: 4px 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    
    .edge-tooltip i {
      margin-right: 5px;
      color: var(--primary);
    }
    
    .toolbar {
      padding: 0.5rem 1rem;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .toolbar > div {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .search-box {
        width: 100%;
      }
      
      .search-box input {
        flex: 1;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .filter-group select {
        width: 100%;
      }
    }
    
    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .search-box input {
      border: none;
      padding: 0.5rem 0.75rem;
      outline: none;
      font-family: inherit;
      font-size: 0.875rem;
      width: 220px;
    }
    
    .search-box .btn {
      border: none;
      border-radius: 0;
      border-left: 1px solid #d1d5db;
      margin: 0;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .btn-group {
      display: flex;
      border: 1px solid #d1d5db;
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .btn-group .btn {
      border: none;
      border-radius: 0;
      border-right: 1px solid #d1d5db;
      margin: 0;
    }
    
    .btn-group .btn:last-child {
      border-right: none;
    }
    
    .search-box {
      display: flex;
      border: 1px solid #d1d5db;
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .search-box input {
      border: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      outline: none;
      min-width: 200px;
    }
    
    .search-box .btn {
      border: none;
      border-radius: 0;
      border-left: 1px solid #d1d5db;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      color: white;
    }
    
    .btn-active {
      background-color: #f0f9ff;
      border-color: #60a5fa;
      color: var(--primary-dark);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn i {
      margin-right: 0.375rem;
      font-size: 0.875rem;
    }
    
    .filter-group {
      display: flex;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .filter-group span {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      border-right: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      color: #6b7280;
    }
    
    .filter-group select {
      border: none;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      outline: none;
      color: #111827;
      flex: 1;
      min-width: 150px;
    }

    .tippy-box {
      background-color: white;
      color: #111827;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.5rem;
      font-size: 0.875rem;
      border: 1px solid #e5e7eb;
    }

    .tippy-content {
      padding: 0.25rem;
    }

    .edge-tooltip {
      font-weight: 500;
      display: flex;
      align-items: center;
    }

    .edge-tooltip i {
      margin-right: 0.375rem;
      color: var(--primary);
    }

    footer {
      padding: 0.75rem;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
      border-top: 1px solid #e5e7eb;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Node styling classes for legend */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.75rem;
      margin-right: 0.75rem;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 0.375rem;
    }

    /* Node type colors */
    .color-application { background-color: var(--primary); }
    .color-service { background-color: var(--success); }
    .color-environment { background-color: var(--warning); }
    .color-service_version { background-color: var(--purple); }
    .color-resource { background-color: var(--info); }
    .color-resource_type { background-color: #90CAF9; }
    .color-resource_register { background-color: #FFD700; }
    .color-policy { background-color: #EF4444; }
  </style>
  
  <style>
    /* Real-time logs panel styles */
    .logs-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
    }

    .logs-title {
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
    }

    .logs-title i {
      margin-right: 0.5rem;
      color: var(--primary);
    }

    .logs-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .connection-status {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .connection-status.connected {
      background: #dcfce7;
      color: #166534;
    }

    .connection-status.disconnected {
      background: #fecaca;
      color: #991b1b;
    }

    .connection-status.connecting {
      background: #fef3c7;
      color: #92400e;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.375rem;
    }

    .status-dot.connected {
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .status-dot.disconnected {
      background: #ef4444;
    }

    .status-dot.connecting {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .logs-content {
      flex: 1;
      overflow-y: auto;
      background: #f9fafb;
      padding: 0.5rem;
      font-family: ui-monospace, monospace;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .log-entry {
      margin-bottom: 0.25rem;
      padding: 0.375rem 0.5rem;
      border-radius: 4px;
      background: white;
      border-left: 3px solid #e5e7eb;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .log-entry:hover {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .log-entry.level-INFO {
      border-left-color: var(--primary);
    }

    .log-entry.level-SUCCESS {
      border-left-color: var(--success);
    }

    .log-entry.level-WARN {
      border-left-color: var(--warning);
    }

    .log-entry.level-ERROR {
      border-left-color: var(--danger);
    }

    .log-timestamp {
      color: #6b7280;
      font-size: 0.75rem;
      white-space: nowrap;
      min-width: 80px;
    }

    .log-level {
      font-weight: 600;
      font-size: 0.75rem;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      min-width: 65px;
      text-align: center;
      white-space: nowrap;
    }

    .log-level.INFO {
      background: #dbeafe;
      color: #1e40af;
    }

    .log-level.SUCCESS {
      background: #dcfce7;
      color: #166534;
    }

    .log-level.WARN {
      background: #fef3c7;
      color: #92400e;
    }

    .log-level.ERROR {
      background: #fecaca;
      color: #991b1b;
    }

    .log-content {
      flex: 1;
      min-width: 0;
    }

    .log-message {
      font-weight: 500;
      color: #111827;
      margin-bottom: 0.125rem;
    }

    .log-details {
      font-size: 0.75rem;
      color: #6b7280;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .log-detail {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .log-detail i {
      width: 12px;
      font-size: 0.7rem;
    }

    .logs-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--gray);
      font-style: italic;
    }

    .logs-empty i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    .logs-filter {
      display: flex;
      gap: 0.25rem;
    }

    .logs-filter select {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      outline: none;
    }

    .btn-toggle {
      background: var(--panel-bg);
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .btn-toggle.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    /* Mobile responsiveness for logs */
    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto 250px;
      }
      
      .panel {
        grid-column: 1;
        grid-row: 2;
        border-left: none;
        border-top: 1px solid #e5e7eb;
        max-height: 200px;
      }
      
      .logs-panel {
        grid-row: 3;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fa-solid fa-diagram-project"></i>
        ZTDP Platform Graph
      </div>
      <div>
        <a href="/graph.html" class="btn">
          <i class="fa-solid fa-rotate-left"></i>
          Classic View
        </a>
      </div>
    </header>
    
    <div class="toolbar">
      <div class="toolbar-actions">
        <button id="btn-fit" class="btn">
          <i class="fa-solid fa-expand"></i>
          Fit View
        </button>
        <button id="btn-layout" class="btn">
          <i class="fa-solid fa-diagram-project"></i>
          Re-layout
        </button>
        <div class="btn-group">
          <button id="btn-zoom-in" class="btn">
            <i class="fa-solid fa-magnifying-glass-plus"></i>
          </button>
          <button id="btn-zoom-out" class="btn">
            <i class="fa-solid fa-magnifying-glass-minus"></i>
          </button>
        </div>
        <button id="btn-focus-resources" class="btn">
          <i class="fa-solid fa-sitemap"></i>
          Focus on Resources
        </button>
        <button id="btn-toggle-chain" class="btn" title="Toggle chain highlighting on/off">
          <i class="fa-solid fa-link"></i>
          Chain View
        </button>
      </div>
      
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Search nodes...">
        <button id="search-button" class="btn">
          <i class="fa-solid fa-search"></i>
        </button>
        <button id="btn-clear-search" class="btn">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      
      <div class="filter-group">
        <span><i class="fa-solid fa-filter"></i></span>
        <select id="node-filter">
          <option value="all">All Node Types</option>
          <option value="application">Applications</option>
          <option value="service">Services</option>
          <option value="environment">Environments</option>
          <option value="service_version">Service Versions</option>
          <option value="resource_register">Resource Catalog</option>
          <option value="resource_type">Resource Types</option>
          <option value="resource">Resource Instances</option>
          <option value="policy">Policies</option>
        </select>
      </div>
      
    </div>

    <div class="content">
      <div id="graph">
        <div class="loading-overlay">
          <div class="loader"></div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-title">
          Details
          <div class="panel-tabs">
            <button class="panel-tab active" data-tab="details">Details</button>
            <button class="panel-tab" data-tab="relations">Relations</button>
          </div>
        </div>
        <div id="details-content" class="tab-content active" data-tab="details">
          <div class="empty-state">
            <i class="fa-solid fa-circle-info"></i>
            <p>Click on a node or edge to see details</p>
          </div>
        </div>
        <div id="relations-content" class="tab-content" data-tab="relations">
          <div class="empty-state">
            <i class="fa-solid fa-circle-info"></i>
            <p>Click on a node to see its relationships</p>
          </div>
          <div id="mini-graph" style="height: 300px; display: none;"></div>
          <div id="relation-list" style="display: none;">
            <div class="section-title" style="margin-top: 1rem;">Connection Details</div>
          </div>
        </div>
        
        <div class="panel-title" style="margin-top: 1.5rem">
          Legend
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color color-application"></div>
            <span>Application</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-service"></div>
            <span>Service</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-environment"></div>
            <span>Environment</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-service_version"></div>
            <span>Service Version</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-resource_register"></div>
            <span>Resource Catalog</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-resource_type"></div>
            <span>Resource Type</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-resource"></div>
            <span>Resource</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-policy"></div>
            <span>Policy</span>
          </div>
        </div>
        
        <div class="panel-title" style="margin-top: 1.5rem">
          Relationship Types
        </div>
        <div class="legend">
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="background-color: #2563EB;"></div>
            <span>owns</span>
          </div>
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="background-color: #8B5CF6;"></div>
            <span>has_version</span>
          </div>
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="background-color: #F59E0B;"></div>
            <span>deploy</span>
          </div>
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="background-color: #06B6D4;"></div>
            <span>uses</span>
          </div>
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="background-color: #10B981;"></div>
            <span>instance_of</span>
          </div>
        </div>

        <div class="panel-title" style="margin-top: 1.5rem">
          Selection Highlights
        </div>
        <div style="font-size: 0.8rem; color: #4b5563; margin-bottom: 0.75rem;">
          When a node is selected, the full relationship chain will be shown:
        </div>
        <div class="legend">
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="border: 3px solid #111827; background-color: transparent;"></div>
            <span>Selected node</span>
          </div>
          <div class="legend-item" style="width: 45%">
            <div class="legend-color" style="border: 2px solid #6366F1; background-color: transparent;"></div>
            <span>Chain nodes</span>
          </div>
        </div>
        <div style="font-size: 0.8rem; color: #4b5563; margin: 0.5rem 0;">
          The selection includes upward relationships (owns, has_version) and downward 
          relationships (deploy, uses, instance_of) automatically, showing the complete
          path from applications to resources.
        </div>
      </div>
      
      <!-- Logs Panel -->
      <div class="logs-panel">
        <div class="logs-header">
          <div class="logs-title">
            <i class="fa-solid fa-stream"></i>
            Real-time Logs
          </div>
          <div class="logs-controls">
            <div class="connection-status" id="connectionStatus">
              <span class="status-dot disconnected"></span>
              <span class="status-text">Disconnected</span>
            </div>
            <div class="logs-actions">
              <button id="toggleConnect" class="btn btn-sm">
                <i class="fa-solid fa-plug"></i>
                Connect
              </button>
              <button id="clearLogs" class="btn btn-sm btn-secondary">
                <i class="fa-solid fa-trash"></i>
                Clear
              </button>
              <button id="toggleLogs" class="btn btn-sm btn-secondary">
                <i class="fa-solid fa-chevron-up"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div class="logs-filters" id="logsFilters">
          <div class="filter-group">
            <label>Level:</label>
            <select id="logLevelFilter" class="filter-select">
              <option value="">All Levels</option>
              <option value="ERROR">Error</option>
              <option value="WARN">Warning</option>
              <option value="INFO">Info</option>
              <option value="SUCCESS">Success</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Event Type:</label>
            <select id="logEventTypeFilter" class="filter-select">
              <option value="">All Events</option>
              <option value="Application Created">Application Created</option>
              <option value="Application Updated">Application Updated</option>
              <option value="Application Deleted">Application Deleted</option>
              <option value="Deployment">Deployment Events</option>
              <option value="Policy">Policy Events</option>
              <option value="Resource">Resource Events</option>
              <option value="Connection">Connection Events</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Component:</label>
            <select id="logComponentFilter" class="filter-select">
              <option value="">All Components</option>
              <option value="application">Application</option>
              <option value="deployment">Deployment</option>
              <option value="policy">Policy</option>
              <option value="resource">Resource</option>
              <option value="websocket">WebSocket</option>
              <option value="event-subscriber">Event Subscriber</option>
              <option value="logs-websocket">Logs WebSocket</option>
              <option value="system">System</option>
            </select>
          </div>
          <div class="filter-group">
            <input type="text" id="logSearchFilter" class="filter-input" placeholder="Search logs...">
          </div>
        </div>
        
        <div class="logs-content" id="logsContent">
          <div class="logs-empty" id="logsEmpty">
            <i class="fa-solid fa-circle-info"></i>
            <p>Connect to view real-time logs</p>
          </div>
          <div class="logs-list" id="logsList"></div>
        </div>
      </div>
    </div>
    
    <footer>
      Zero Touch Developer Platform | Graph Visualization
    </footer>
  </div>
  
  <script>
    // Initialize Cytoscape
    const cy = cytoscape({
      container: document.getElementById('graph'),
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'color': '#fff',
            'font-weight': 500,
            'text-valign': 'center',
            'text-halign': 'center',
            'text-outline-width': 2,
            'text-outline-opacity': 0.5,
            'font-size': 12,
            'text-wrap': 'wrap',
            'text-max-width': '100px',
            'transition-property': 'background-color, border-color, opacity, width, height',
            'transition-duration': '0.3s'
          }
        },
        {
          selector: 'node[kind="application"]',
          style: {
            'background-color': '#3B82F6', // Primary blue
            'text-outline-color': '#2563EB',
            'width': 60,
            'height': 60,
            'font-size': 13,
            'border-width': 1,
            'border-color': '#2563EB',
            'border-opacity': 0.5
          }
        },
        {
          selector: 'node[kind="service"]',
          style: {
            'background-color': '#10B981', // Success green
            'text-outline-color': '#059669',
            'width': 50,
            'height': 50,
            'font-size': 12,
            'border-width': 1,
            'border-color': '#059669',
            'border-opacity': 0.5
          }
        },
        {
          selector: 'node[kind="service_version"]',
          style: {
            'background-color': '#8B5CF6', // Purple
            'text-outline-color': '#7C3AED',
            'width': 40,
            'height': 40,
            'font-size': 11,
            'border-width': 1,
            'border-color': '#7C3AED',
            'border-opacity': 0.5
          }
        },
        {
          selector: 'node[kind="environment"]',
          style: {
            'background-color': '#F59E0B', // Warning amber
            'text-outline-color': '#D97706',
            'width': 45,
            'height': 45,
            'font-size': 12,
            'border-width': 1,
            'border-color': '#D97706',
            'border-opacity': 0.5
          }
        },
        {
          selector: 'node[kind="resource_register"]',
          style: {
            'background-color': '#FFD700', // Gold
            'text-outline-color': '#B8860B',
            'color': '#111827',
            'width': 75,
            'height': 75,
            'font-size': 14,
            'font-weight': 600,
            'border-width': 2,
            'border-color': '#B8860B',
            'border-opacity': 0.8
          }
        },
        {
          selector: 'node[kind="resource_type"]',
          style: {
            'background-color': '#90CAF9', // Light blue
            'text-outline-color': '#42A5F5',
            'color': '#1A237E',
            'width': 55,
            'height': 55,
            'font-size': 13,
            'border-width': 2,
            'border-color': '#1976D2',
            'border-opacity': 0.6
          }
        },
        {
          selector: 'node[kind="resource"]',
          style: {
            'background-color': '#06B6D4', // Info teal
            'text-outline-color': '#0891B2',
            'width': 50,
            'height': 50,
            'font-size': 12,
            'border-width': 1,
            'border-color': '#0891B2',
            'border-opacity': 0.5
          }
        },
        {
          selector: 'node[kind="policy"]',
          style: {
            'background-color': '#EF4444', // Red for policy
            'text-outline-color': '#B91C1C',
            'color': '#fff',
            'width': 48,
            'height': 48,
            'font-size': 13,
            'font-weight': 600,
            'border-width': 2,
            'border-color': '#B91C1C',
            'border-opacity': 0.8
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2.5,
            'line-color': '#CBD5E1',
            'target-arrow-color': '#94A3B8',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'arrow-scale': 0.8,
            'opacity': 0.8,
            'transition-property': 'line-color, opacity, width',
            'transition-duration': '0.2s',
            'text-opacity': 1 // Ensure edge labels have full opacity by default
          }
        },
        {
          selector: 'edge[label="owns"]',
          style: {
            'line-color': '#2563EB',
            'target-arrow-color': '#2563EB',
            'line-style': 'solid',
            'width': 3
          }
        },
        {
          selector: 'edge[label="has_version"]',
          style: {
            'line-color': '#8B5CF6',
            'target-arrow-color': '#8B5CF6',
            'line-style': 'solid'
          }
        },
        {
          selector: 'edge[label="deploy"]',
          style: {
            'line-color': '#F59E0B',
            'target-arrow-color': '#F59E0B',
            'line-style': 'solid'
          }
        },
        {
          selector: 'edge[label="uses"]',
          style: {
            'line-color': '#06B6D4',
            'target-arrow-color': '#06B6D4',
            'line-style': 'dashed',
            'line-dash-pattern': [6, 3]
          }
        },
        {
          selector: 'edge[label="instance_of"]',
          style: {
            'line-color': '#10B981',
            'target-arrow-color': '#10B981',
            'line-style': 'dashed',
            'line-dash-pattern': [6, 3]
          }
        },
        {
          selector: '.highlighted',
          style: {
            'border-width': 3,
            'border-color': '#111827',
            'border-opacity': 1,
            'opacity': 1,
            'z-index': 999
          }
        },
        {
          selector: '.highlighted-edge',
          style: {
            'width': 4,
            'opacity': 1,
            'z-index': 999
          }
        },
        {
          selector: '.faded',
          style: {
            'opacity': 0.15,
            'text-opacity': 0.15
          }
        },
        {
          selector: '.hover-faded',
          style: {
            'opacity': 0.6,
            'text-opacity': 0.8
          }
        },
        {
          selector: '.chain-node',
          style: {
            'opacity': 1,
            'border-width': 2,
            'border-color': '#6366F1',
            'border-opacity': 0.8,
            'background-color': function(ele) {
              // Get the original background color and make it slightly brighter
              return ele.style('background-color');
            }
          }
        },
        {
          selector: '.chain-edge',
          style: {
            'opacity': 0.9,
            'line-color': '#6366F1',
            'target-arrow-color': '#6366F1',
            'width': 3,
            'z-index': 900
          }
        }
      ]
    });

    // Register the layout extensions
    cytoscape.use(cytoscapeDagre);
    
    // Helper to format JSON objects
    function formatJSON(obj) {
      if (typeof obj !== 'object' || obj === null) return String(obj);
      return JSON.stringify(obj, null, 2);
    }
    
    // Global variables to track state
    let selectedNode = null;
    let selectedEdge = null;
    let enableChainHighlight = true; // By default, enable chain highlighting
    
    // Create a mini-graph instance for the relations view
    const miniCy = cytoscape({
      container: document.getElementById('mini-graph'),
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'color': '#fff',
            'background-color': '#95a5a6',
            'font-weight': 500,
            'text-valign': 'center',
            'text-halign': 'center',
            'text-outline-width': 2,
            'text-outline-color': '#95a5a6',
            'font-size': 10,
          }
        },
        {
          selector: 'node.source',
          style: {
            'background-color': '#3498db',
            'border-width': 2,
            'border-color': '#2980b9',
            'text-outline-color': '#3498db',
            'width': 30,
            'height': 30
          }
        },
        {
          selector: 'edge.incoming',
          style: {
            'line-color': '#e74c3c',
            'target-arrow-color': '#e74c3c',
          }
        },
        {
          selector: 'edge.outgoing',
          style: {
            'line-color': '#2ecc71',
            'target-arrow-color': '#2ecc71',
          }
        }
      ],
      layout: {
        name: 'dagre',
        padding: 10,
        animate: true,
        nodeDimensionsIncludeLabels: true,
        fit: true,
      }
    });
    
    // Function to update the relations view
    function updateRelationsView(node) {
      // Get the mini-graph container and relation list
      const miniGraphEl = document.getElementById('mini-graph');
      const relationListEl = document.getElementById('relation-list');
      
      // Show them
      miniGraphEl.style.display = 'block';
      relationListEl.style.display = 'block';
      
      // Clear the current content
      miniCy.elements().remove();
      
      // Get connected nodes and edges
      const neighborhood = node.neighborhood();
      const connectedEdges = node.connectedEdges();
      
      // Add the center node
      miniCy.add({
        group: 'nodes',
        data: {
          id: node.id(),
          label: node.data('label'),
        },
        classes: 'source'
      });
      
      // Add connected nodes
      neighborhood.nodes().forEach(n => {
        miniCy.add({
          group: 'nodes',
          data: {
            id: n.id(),
            label: n.data('label'),
          }
        });
      });
      
      // Add edges with direction classes
      connectedEdges.forEach(edge => {
        // Determine if this is an incoming or outgoing edge
        const isOutgoing = edge.source().id() === node.id();
        const cls = isOutgoing ? 'outgoing' : 'incoming';
        
        miniCy.add({
          group: 'edges',
          data: {
            id: edge.id(),
            source: edge.source().id(),
            target: edge.target().id(),
            label: edge.data('label'),
          },
          classes: cls
        });
      });
      
      // Run the layout
      miniCy.layout({
        name: 'dagre',
        padding: 10,
        animate: true,
        nodeDimensionsIncludeLabels: true,
        fit: true
      }).run();
      
      // Build the relation list HTML
      let html = '<div class="detail-section">';
      
      // Count edges by type
      const edgeCounts = {};
      connectedEdges.forEach(edge => {
        const label = edge.data('label');
        edgeCounts[label] = (edgeCounts[label] || 0) + 1;
      });
      
      // Add summary
      html += `<table class="detail-table">
        <tr>
          <td>Connected nodes</td>
          <td>${neighborhood.nodes().length}</td>
        </tr>
        <tr>
          <td>Relationships</td>
          <td>${connectedEdges.length}</td>
        </tr>
      </table>`;
      
      // Add edge type breakdown
      html += '<div class="section-title">Relationship Types</div>';
      html += '<table class="detail-table">';
      
      for (const [type, count] of Object.entries(edgeCounts)) {
        html += `<tr>
          <td>${type}</td>
          <td>${count}</td>
        </tr>`;
      }
      
      html += '</table></div>';
      
      // Update the relation list content
      relationListEl.innerHTML = html;
    }
    
    // Function to render node details
    function renderNodeDetails(node) {
      // Store selected node globally
      selectedNode = node;
      
      const detailsEl = document.getElementById('details-content');
      const data = node.data('details');
      const kind = data.kind || data.Kind;
      const name = (data.metadata && (data.metadata.name || data.metadata.Name)) || data.ID || data.id;
      
      // Define icon and color based on node kind
      let iconClass, colorClass;
      switch(kind) {
        case 'application':
          iconClass = 'fa-solid fa-cube';
          colorClass = 'color-application';
          break;
        case 'service':
          iconClass = 'fa-solid fa-server';
          colorClass = 'color-service';
          break;
        case 'environment':
          iconClass = 'fa-solid fa-cloud';
          colorClass = 'color-environment';
          break;
        case 'service_version':
          iconClass = 'fa-solid fa-code-branch';
          colorClass = 'color-service_version';
          break;
        case 'resource_register':
          iconClass = 'fa-solid fa-database';
          colorClass = 'color-resource_register';
          break;
        case 'resource_type':
          iconClass = 'fa-solid fa-layer-group';
          colorClass = 'color-resource_type';
          break;
        case 'resource':
          iconClass = 'fa-solid fa-hdd';
          colorClass = 'color-resource';
          break;
        case 'policy':
          iconClass = 'fa-solid fa-shield-alt';
          colorClass = 'color-policy';
          break;
        default:
          iconClass = 'fa-solid fa-circle';
          colorClass = '';
      }
      
      // Start building HTML
      let html = `
        <div class="node-detail-header">
          <div class="node-icon ${colorClass}">
            <i class="${iconClass}"></i>
          </div>
          <div class="node-title">
            ${name}
            <div class="node-kind">${kind}</div>
          </div>
        </div>
      `;
      
      // Add metadata section
      if (data.metadata) {
        html += `<div class="detail-section">
          <div class="section-title">Metadata</div>
          <table class="detail-table">`;
        
        for (const [key, value] of Object.entries(data.metadata)) {
          html += `<tr>
            <td>${key}</td>
            <td>${typeof value === 'object' ? 
              `<div class="detail-value">${formatJSON(value)}</div>` : 
              value}</td>
          </tr>`;
        }
        
        html += `</table></div>`;
      }
      
      // Add spec section
      if (data.spec) {
        html += `<div class="detail-section">
          <div class="section-title">Specification</div>
          <table class="detail-table">`;
        
        for (const [key, value] of Object.entries(data.spec)) {
          html += `<tr>
            <td>${key}</td>
            <td>${typeof value === 'object' ? 
              `<div class="detail-value">${formatJSON(value)}</div>` : 
              value}</td>
          </tr>`;
        }
        
        html += `</table></div>`;
      }
      
      // Add connections section
      html += `<div class="detail-section">
        <div class="section-title">Connections</div>`;
      
      const connections = {
        incoming: [],
        outgoing: []
      };
      
      // Find incoming edges
      cy.edges().forEach(edge => {
        if (edge.target().id() === node.id()) {
          connections.incoming.push({
            type: edge.data('label'),
            node: edge.source().data('label')
          });
        }
        if (edge.source().id() === node.id()) {
          connections.outgoing.push({
            type: edge.data('label'),
            node: edge.target().data('label')
          });
        }
      });
      
      // Show incoming connections
      if (connections.incoming.length) {
        html += `<table class="detail-table">
          <tr>
            <td>Incoming</td>
            <td>
        `;
        
        connections.incoming.forEach(conn => {
          html += `<div><i class="fa-solid fa-arrow-right-long"></i> ${conn.type} from ${conn.node}</div>`;
        });
        
        html += `</td></tr></table>`;
      }
      
      // Show outgoing connections
      if (connections.outgoing.length) {
        html += `<table class="detail-table">
          <tr>
            <td>Outgoing</td>
            <td>
        `;
        
        connections.outgoing.forEach(conn => {
          html += `<div><i class="fa-solid fa-arrow-right-long"></i> ${conn.type} to ${conn.node}</div>`;
        });
        
        html += `</td></tr></table>`;
      }
      
      html += `</div>`;
      
      detailsEl.innerHTML = html;
    }

    // Function to render edge details
    function renderEdgeDetails(edge) {
      const detailsEl = document.getElementById('details-content');
      const edgeData = edge.data();
      const metadata = edgeData.metadata || {};
      
      // Get source and target node info
      const sourceNode = edge.source();
      const targetNode = edge.target();
      const sourceName = sourceNode.data('label') || sourceNode.id();
      const targetName = targetNode.data('label') || targetNode.id();
      const edgeType = edgeData.label || edgeData.type || 'Unknown';
      
      // Define icon and color based on edge type
      let iconClass, colorClass;
      switch(edgeType.toLowerCase()) {
        case 'deploy':
        case 'deployment':
          iconClass = 'fa-solid fa-rocket';
          colorClass = 'color-deployment';
          break;
        case 'uses':
        case 'depends_on':
          iconClass = 'fa-solid fa-link';
          colorClass = 'color-dependency';
          break;
        case 'has_version':
          iconClass = 'fa-solid fa-code-branch';
          colorClass = 'color-version';
          break;
        case 'owns':
          iconClass = 'fa-solid fa-user-shield';
          colorClass = 'color-ownership';
          break;
        case 'instance_of':
          iconClass = 'fa-solid fa-copy';
          colorClass = 'color-instance';
          break;
        default:
          iconClass = 'fa-solid fa-arrow-right';
          colorClass = 'color-edge';
      }
      
      // Start building HTML
      let html = `
        <div class="edge-detail-header">
          <div class="edge-icon ${colorClass}">
            <i class="${iconClass}"></i>
          </div>
          <div class="edge-title">
            ${edgeType}
            <div class="edge-connection">
              ${sourceName} â†’ ${targetName}
            </div>
          </div>
        </div>
      `;
      
      // Add basic edge information
      html += `<div class="detail-section">
        <div class="section-title">Connection</div>
        <table class="detail-table">
          <tr>
            <td>Type</td>
            <td>${edgeType}</td>
          </tr>
          <tr>
            <td>Source</td>
            <td>${sourceName}</td>
          </tr>
          <tr>
            <td>Target</td>
            <td>${targetName}</td>
          </tr>
        </table>
      </div>`;
      
      // Add deployment metadata section if it exists
      if (metadata.deployment) {
        const deploymentMeta = metadata.deployment;
        html += `<div class="detail-section">
          <div class="section-title">Deployment Status</div>
          <table class="detail-table">`;
        
        if (deploymentMeta.status) {
          const statusClass = `status-${deploymentMeta.status.toLowerCase().replace('_', '-')}`;
          html += `<tr>
            <td>Status</td>
            <td><span class="status-badge ${statusClass}">${deploymentMeta.status}</span></td>
          </tr>`;
        }
        
        if (deploymentMeta.message) {
          html += `<tr>
            <td>Message</td>
            <td>${deploymentMeta.message}</td>
          </tr>`;
        }
        
        if (deploymentMeta.last_updated) {
          const lastUpdated = new Date(deploymentMeta.last_updated).toLocaleString();
          html += `<tr>
            <td>Last Updated</td>
            <td>${lastUpdated}</td>
          </tr>`;
        }
        
        if (deploymentMeta.progress !== undefined) {
          const progressPercent = Math.round(deploymentMeta.progress * 100);
          html += `<tr>
            <td>Progress</td>
            <td>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercent}%"></div>
              </div>
              <span class="progress-text">${progressPercent}%</span>
            </td>
          </tr>`;
        }
        
        if (deploymentMeta.progress_message) {
          html += `<tr>
            <td>Progress Message</td>
            <td>${deploymentMeta.progress_message}</td>
          </tr>`;
        }
        
        html += `</table></div>`;
        
        // Add deployment events if they exist
        if (deploymentMeta.events && deploymentMeta.events.length > 0) {
          html += `<div class="detail-section">
            <div class="section-title">Deployment Events</div>
            <div class="events-list">`;
          
          deploymentMeta.events.slice(0, 5).forEach(event => {
            const eventTime = new Date(event.timestamp).toLocaleTimeString();
            const levelClass = `event-${event.level.toLowerCase()}`;
            html += `
              <div class="event-item ${levelClass}">
                <div class="event-header">
                  <span class="event-level">${event.level}</span>
                  <span class="event-time">${eventTime}</span>
                </div>
                <div class="event-message">${event.message}</div>
              </div>
            `;
          });
          
          if (deploymentMeta.events.length > 5) {
            html += `<div class="event-item more-events">
              +${deploymentMeta.events.length - 5} more events
            </div>`;
          }
          
          html += `</div></div>`;
        }
      }
      
      // Add all metadata section if there's additional metadata
      if (Object.keys(metadata).length > 0) {
        html += `<div class="detail-section">
          <div class="section-title">Metadata</div>
          <table class="detail-table">`;
        
        for (const [key, value] of Object.entries(metadata)) {
          if (key !== 'deployment') { // Skip deployment metadata as it's shown above
            html += `<tr>
              <td>${key}</td>
              <td>${typeof value === 'object' ? 
                `<div class="detail-value">${formatJSON(value)}</div>` : 
                value}</td>
            </tr>`;
          }
        }
        
        html += `</table></div>`;
      }
      
      detailsEl.innerHTML = html;
    }

    // Show empty state when no element is selected
    function showEmptyDetails() {
      const detailsEl = document.getElementById('details-content');
      detailsEl.innerHTML = `
        <div class="empty-state">
          <i class="fa-solid fa-circle-info"></i>
          <p>Click on a node or edge to see details</p>
        </div>
      `;
    }

    // Node filter function
    function filterNodesByKind(value) {
      if (value === 'all') {
        cy.elements().removeClass('faded');
      } else {
        // First fade all nodes
        cy.elements().addClass('faded');
        
        // Then unfade the selected nodes and their connected edges
        const selectedNodes = cy.nodes(`[kind="${value}"]`);
        selectedNodes.removeClass('faded');
        
        // Also unfade the edges connected to the selected nodes
        selectedNodes.connectedEdges().removeClass('faded');
        
        // No notification for node count
      }
    }
    
    // Old notification function, removed in favor of the unified one below
    
    // Search function
    function performSearch(query) {
      query = query.trim().toLowerCase();
      
      if (!query) {
        cy.elements().removeClass('faded');
        return;
      }
      
      // Fade all elements
      cy.elements().addClass('faded');
      
      // Find matching nodes
      const matchingNodes = cy.nodes().filter(node => {
        const label = node.data('label').toLowerCase();
        const kind = node.data('kind').toLowerCase();
        const isMatch = label.includes(query) || kind.includes(query);
        
        // Also search in metadata and spec
        if (!isMatch) {
          const metadata = node.data('details').metadata;
          const spec = node.data('details').spec;
          
          for (const key in metadata) {
            if (String(metadata[key]).toLowerCase().includes(query)) {
              return true;
            }
          }
          
          for (const key in spec) {
            if (String(spec[key]).toLowerCase().includes(query)) {
              return true;
            }
          }
        }
        
        return isMatch;
      });
      
      if (matchingNodes.length === 0) {
        // No notification for no matches
        cy.elements().removeClass('faded');
        return;
      }
      
      // Highlight matched nodes
      matchingNodes.removeClass('faded');
      
      // Also show direct connections between matching nodes
      matchingNodes.edgesWith(matchingNodes).removeClass('faded');
      
      // No notification - removed
      
      // Fit to show matching nodes
      cy.fit(matchingNodes, 50);
    }
    
    // Focus on resources
    function focusOnResources() {
      // Reset view
      cy.elements().removeClass('faded highlighted highlighted-edge');
      
      // Identify the resource catalog node
      const resourceCatalog = cy.nodes('[kind="resource_register"]');
      
      // Find resource types and resources
      const resourceTypes = cy.nodes('[kind="resource_type"]');
      const resources = cy.nodes('[kind="resource"]');
      
      if (!resourceCatalog.length && !resourceTypes.length && !resources.length) {
        // No notification
        return;
      }
      
      // Fade all nodes
      cy.elements().addClass('faded');
      
      // Unfade the resource catalog, types and resources
      resourceCatalog.removeClass('faded');
      resourceTypes.removeClass('faded');
      resources.removeClass('faded');
      
      // Also unfade the edges between these nodes
      resourceCatalog.edgesWith(resourceTypes).removeClass('faded');
      resourceTypes.edgesWith(resources).removeClass('faded');
      
      // Get applications that own resources
      const applications = cy.nodes('[kind="application"]');
      const ownsEdges = cy.edges('[label="owns"]');
      const appWithResources = applications.filter(app => {
        return ownsEdges.some(edge => 
          edge.source().id() === app.id() && 
          resources.some(res => res.id() === edge.target().id())
        );
      });
      
      appWithResources.removeClass('faded');
      
      // Show edges between apps and resources
      appWithResources.edgesWith(resources).filter('[label="owns"]').removeClass('faded');        // Fit to show the relevant nodes
      const nesToFit = resourceCatalog.union(resourceTypes).union(resources).union(appWithResources);
      cy.fit(nesToFit, 50);
      
      // Apply a resource-focused layout
      cy.layout({
        name: 'dagre',
        animate: true,
        rankDir: 'LR',
        nodeDimensionsIncludeLabels: true,
        fit: true,
        padding: 50,
        rankSep: 100,
        edgeSep: 50
      }).run();
      
      // No notification
    }

    // Run the layout with better error handling
    function runLayout() {
      console.log("Running layout with", cy.elements().length, "elements");
      if (cy.elements().length === 0) {
        console.warn("No elements to layout");
        return;
      }
      // If we have more than 100 elements, use a simpler layout approach
      const useSimpleLayout = cy.elements().length > 100;
      try {
        if (useSimpleLayout) {
          console.log("Using simplified layout for large graph");
          cy.layout({
            name: 'cose',
            animate: false,
            fit: true,
            padding: 50,
            randomize: true,
            nodeDimensionsIncludeLabels: true
          }).run();
        } else {
          console.log("Using dagre layout");
          cy.layout({
            name: 'dagre',
            animate: true,
            fit: true,
            padding: 50,
            nodeDimensionsIncludeLabels: true,
            rankDir: 'LR',
            rankSep: 100,
            edgeSep: 50
          }).run();
        }
      } catch (err) {
        console.error("Layout engine error:", err);
        showNotification("Layout error - falling back to simple layout", "warning");
        cy.layout({
          name: 'cose',
          fit: true,
          padding: 75,
          animate: false,
          nodeDimensionsIncludeLabels: true,
          randomize: true
        }).run();
      }
    }

    // Function to create edge tooltips using an alternative approach
    function createEdgeTooltips() {
      // Create a tooltip div that will be positioned manually
      const tooltip = document.createElement('div');
      tooltip.className = 'edge-tooltip';
      tooltip.style.position = 'absolute';
      tooltip.style.display = 'none';
      tooltip.style.zIndex = '10';
      tooltip.style.backgroundColor = 'white';
      tooltip.style.padding = '5px 8px';
      tooltip.style.borderRadius = '4px';
      tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      tooltip.style.fontSize = '12px';
      tooltip.style.pointerEvents = 'none';
      document.body.appendChild(tooltip);
      
      // Edge mouse events for tooltip
      cy.on('mouseover', 'edge', function(e) {
        const edge = e.target;
        const label = edge.data('label');
        
        // Choose icon based on edge type
        let iconClass;
        switch(label) {
          case 'owns':
            iconClass = 'fa-solid fa-cubes';
            break;
          case 'has_version':
            iconClass = 'fa-solid fa-code-branch';
            break;
          case 'deploy':
            iconClass = 'fa-solid fa-rocket';
            break;
          case 'uses':
            iconClass = 'fa-solid fa-arrow-right-arrow-left';
            break;
          case 'instance_of':
            iconClass = 'fa-solid fa-sitemap';
            break;
          default:
            iconClass = 'fa-solid fa-link';
        }
        
        tooltip.innerHTML = `<i class="${iconClass}"></i> ${label}`;
        tooltip.style.display = 'block';
        
        // Position the tooltip near the mouse
        const renderedPosition = e.renderedPosition;
        tooltip.style.left = (renderedPosition.x + window.pageXOffset) + 'px';
        tooltip.style.top = (renderedPosition.y + window.pageYOffset - 30) + 'px';
      });
      
      cy.on('mouseout', 'edge', function() {
        tooltip.style.display = 'none';
      });
      
      // Update tooltip position when the mouse moves over an edge
      cy.on('mousemove', 'edge', function(e) {
        const renderedPosition = e.renderedPosition;
        tooltip.style.left = (renderedPosition.x + window.pageXOffset) + 'px';
        tooltip.style.top = (renderedPosition.y + window.pageYOffset - 30) + 'px';
      });
    }      // Unified notification function
      function showNotification(message, type = 'info') {
        // Create notification element
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.innerHTML = `
          <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 
                               type === 'warning' ? 'fa-exclamation-triangle' : 
                               type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        `;
        
        // Add to DOM
        document.body.appendChild(notif);
        
        // Animate in
        setTimeout(() => {
          notif.classList.add('show');
        }, 10);
        
        // Remove after delay
        setTimeout(() => {
          notif.classList.remove('show');
          setTimeout(() => {
            notif.remove();
          }, 300);
        }, 3000);
        
        console.log(`Notification: ${message} (${type})`); // Log to help debug
      }
      
      // This is a duplicate function that's been removed, using the one defined earlier
      
      // Using the performSearch function defined earlier instead of duplicating logic
      
      // Function to show empty details panel state
      function showEmptyDetails() {
        document.getElementById('details-content').innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-circle-info"></i>
            <p>Click on a node to see details</p>
          </div>
        `;
        
        document.getElementById('relations-content').innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-circle-info"></i>
            <p>Click on a node to see its relationships</p>
          </div>
          <div id="mini-graph" style="height: 300px; display: none;"></div>
          <div id="relation-list" style="display: none;"></div>
        `;
        
        // Reset selected node
        selectedNode = null;
      }
      
      // Function to switch tabs in the panel
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.panel-tab').forEach(tab => {
          if (tab.dataset.tab === tabName) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
        
        // Update tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          if (content.dataset.tab === tabName) {
            content.classList.add('active');
            
            // Special handling for the relations tab - update mini graph layout
            if (tabName === 'relations' && selectedNode) {
              updateRelationsView(selectedNode);
              setTimeout(() => {
                if (miniCy) {
                  miniCy.fit();
                }
              }, 100);
            }
          } else {
            content.classList.remove('active');
          }
        });
      }
      
      // Setup event listeners for UI controls
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM loaded, setting up event handlers");
        
        // Set up node filter
        const nodeFilter = document.getElementById('node-filter');
        if (nodeFilter) {
          console.log("Setting up node filter");
          nodeFilter.addEventListener('change', function() {
            const value = this.value;
            console.log("Node filter changed to:", value);
            filterNodesByKind(value);
          });
        } else {
          console.warn("Node filter element not found");
        }
        
        // Zoom controls
        const zoomInBtn = document.getElementById('btn-zoom-in');
        if (zoomInBtn) {
          zoomInBtn.addEventListener('click', () => {
            cy.zoom(cy.zoom() * 1.2);
            // No notification
          });
        } else {
          console.warn("Zoom in button not found");
        }
        
        document.getElementById('btn-zoom-out').addEventListener('click', () => {
          cy.zoom(cy.zoom() * 0.8);
          // No notification
        });
        
        // Fit view button
        document.getElementById('btn-fit').addEventListener('click', () => {
          cy.fit(cy.elements(':visible'), 50);
          // No notification
        });
        
        // Re-layout button
        document.getElementById('btn-layout').addEventListener('click', () => {
          // Clear any highlighting or fading before re-layouting
          cy.elements().removeClass('highlighted highlighted-edge faded hover-faded chain-node chain-edge');
          runLayout();
          // No notification
        });
        
        // Focus on resources button
        document.getElementById('btn-focus-resources').addEventListener('click', focusOnResources);
        
        // Chain toggle button
        document.getElementById('btn-toggle-chain').addEventListener('click', () => {
          // Toggle the state
          enableChainHighlight = !enableChainHighlight;
          
          // Update button appearance
          const btnChainToggle = document.getElementById('btn-toggle-chain');
          if (enableChainHighlight) {
            btnChainToggle.classList.add('btn-active');
            btnChainToggle.title = "Chain highlighting enabled - click to disable";
          } else {
            btnChainToggle.classList.remove('btn-active');
            btnChainToggle.title = "Chain highlighting disabled - click to enable";
          }
          
          // Reapply highlighting if a node is currently selected
          if (selectedNode) {
            // Trigger a fake tap event to refresh the view
            cy.$(`#${selectedNode.id()}`).trigger('tap');
          }
        });
        
        // Set initial state of chain toggle button
        document.getElementById('btn-toggle-chain').classList.add('btn-active');
        
        // Search box
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        
        searchButton.addEventListener('click', () => {
          performSearch(searchInput.value);
        });
        
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            performSearch(searchInput.value);
          }
        });
        
        // Reset search/filter button
        document.getElementById('btn-clear-search').addEventListener('click', () => {
          searchInput.value = '';
          cy.elements().removeClass('faded highlighted highlighted-edge chain-node chain-edge hover-faded');
          cy.fit(cy.elements(), 50);
          // No notification
        });
        
        // Tab switching
        document.querySelectorAll('.panel-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchTab(tabName);
          });
        });
      });

      // Transform graph data into Cytoscape format
const transformGraphData = (data) => {
  const elements = [];
  // Process nodes (API uses 'ID' and 'Kind')
  if (data.Nodes) {
    Object.values(data.Nodes).forEach(node => {
      if (!node || !node.ID) return;
      elements.push({
        group: 'nodes',
        data: {
          id: node.ID,
          label: node.Metadata && node.Metadata.name ? node.Metadata.name : node.ID,
          type: node.Kind || 'unknown',
          ...node
        }
      });
    });
  }
  // Process edges (API may use 'From'/'To' or 'Source'/'Target')
  if (data.Edges) {
    let edges = Object.values(data.Edges).flatMap(e => Array.isArray(e) ? e : [e]);
    edges.forEach(edge => {
      const source = edge.From || edge.Source;
      const target = edge.To || edge.Target;
      if (!source || !target) return;
      elements.push({
        group: 'edges',
        data: {
          id: edge.ID || `${source}-${target}`,
          source,
          target,
          label: edge.Kind || edge.Type || 'link',
          type: edge.Kind || edge.Type || 'standard',
          ...edge
        }
      });
    });
  }
  return elements;
};

// Fetch and process graph data
    console.log("Fetching graph data from /v1/graph...");
    
    // Function to retry fetch with exponential backoff
    function fetchWithRetry(url, options = {}, retries = 3, backoff = 300) {
      return new Promise((resolve, reject) => {
        const attemptFetch = (retriesLeft) => {
          console.log(`Attempting to fetch data, ${retriesLeft} retries left`);
          
          fetch(url, options)
            .then(res => {
              console.log("Response received:", res.status);
              if (!res.ok) {
                throw new Error(`HTTP error! Status: ${res.status}`);
              }
              return res.json();
            })
            .then(resolve)
            .catch(err => {
              if (retriesLeft === 0) {
                return reject(err);
              }
              
              console.log(`Fetch failed, retrying in ${backoff}ms...`, err);
              setTimeout(() => {
                attemptFetch(retriesLeft - 1);
              }, backoff);
            });
        };
        
        attemptFetch(retries);
      });
    }
    
    // Use the retry function
    fetchWithRetry('/v1/graph')
      .then(data => {
        console.log("Data received:", data);
        
        // Add more detailed logging for troubleshooting
        console.log("Response data type:", typeof data);
        console.log("Response structure:", Object.keys(data));
        
        // Check for capitalization in the response
        const hasNodes = data.Nodes || data.nodes;
        const hasEdges = data.Edges || data.edges;
        
        // Normalize data structure to ensure we have Nodes and Edges properties
        if (data.nodes && !data.Nodes) data.Nodes = data.nodes;
        if (data.edges && !data.Edges) data.Edges = data.edges;
        
        if (!hasNodes || !hasEdges) {
          console.error("Missing nodes or edges in the response:", data);
          throw new Error('Invalid graph data format received from the server');
        }
        
        console.log("Processing graph with", Object.keys(data.Nodes).length, "nodes and", Object.keys(data.Edges).length, "edge sources");
        
        // Create nodes
        const nodes = Object.values(data.Nodes).map(n => {
          const metadata = n.metadata || n.Metadata || {};
          const name = (metadata.name || metadata.Name || n.ID || n.id);
          const kind = n.kind || n.Kind || 'unknown';
          let label;
          if (kind === 'policy') {
            label = metadata.title || metadata.name || n.ID || n.id || 'Policy';
          } else if (kind === 'service_version') {
            // Always show full service:version (e.g., checkout-api:2.0.0)
            label = n.ID || n.id || name;
          } else if (kind === 'process') {
            // Show full process node ID (e.g., checkout-api:2.0.0-deploy-prod)
            label = n.ID || n.id || name;
          } else if (kind === 'resource' || kind === 'resource_type') {
            label = name;
          } else if (kind === 'resource_register') {
            label = 'Resource Catalog';
          } else {
            label = name;
          }
          return {
            data: {
              id: n.id || n.ID,
              label: label,
              kind: kind,
              details: n
            }
          };
        });
        
        // Create edges with better error handling
        const edges = [];
        for (const [from, edgeList] of Object.entries(data.Edges || data.edges)) {
          // Handle both array and object formats
          const edgesToProcess = Array.isArray(edgeList) ? edgeList : [edgeList];
          edgesToProcess.forEach(edge => {
            // Support all possible property names
            const to = edge.to || edge.To || edge.target || edge.Target;
            const type = edge.type || edge.Type || edge.kind || edge.Kind || edge.label;
            const metadata = edge.metadata || edge.Metadata || {};
            // Use ID if present, else fallback to from-to-type
            const edgeId = edge.ID || edge.id || `${from}-${to}-${type}`;
            if (!to || !type) {
              console.warn("Edge missing required properties:", edge);
              return; // Skip this edge
            }
            
            console.log(`Creating edge ${edgeId} with metadata:`, metadata);
            
            edges.push({
              data: {
                id: edgeId,
                source: from,
                target: to,
                label: type,
                metadata: metadata,
                details: {
                  type: type,
                  metadata: metadata
                }
              }
            });
          });
        }

        // Load elements into cytoscape
        try {
          cy.add([...nodes, ...edges]);
          console.log("Successfully added nodes and edges to cytoscape");
          
          // Check if we have elements in the graph
          if (cy.elements().length === 0) {
            console.warn("No elements added to cytoscape graph");
            throw new Error("Failed to render graph - no elements were created.");
          }
          
          // Remove the loading overlay
          document.querySelector('.loading-overlay').style.display = 'none';
          
          // No notification for graph load
          
          // Run the initial layout with a more robust approach
          try {
            console.log("Starting initial layout...");
            runLayout();
          } catch (layoutError) {
            console.error("Error in layout algorithm:", layoutError);
            
            // Try a simpler layout as fallback
            console.log("Trying fallback layout...");
            cy.layout({
              name: 'preset',
              padding: 50,
              fit: true,
              animate: false
            }).run();
            
            // No notification for fallback layout
          }
        } catch(renderErr) {
          console.error("Error rendering graph:", renderErr);
          throw new Error(`Error rendering graph: ${renderErr.message}`);
        }
        
        // Create edge tooltips
        createEdgeTooltips();
        
        // Function to traverse the graph and find all connected nodes in a chain
        function findConnectedNodesInChain(startNode) {
          // Keep track of all nodes that should be highlighted
          const nodesToHighlight = cy.collection();
          nodesToHighlight.merge(startNode);
          
          // Find application chain (upward traversal)
          // Common relationships going up: has_version, owns
          function traverseUpward(currentNode, visited = new Set()) {
            // Avoid cycles
            if (visited.has(currentNode.id())) return;
            visited.add(currentNode.id());
            
            // Add this node to the collection
            nodesToHighlight.merge(currentNode);
            
            // Find incoming edges with relevant relationships
            const upwardEdges = currentNode.connectedEdges().filter(edge => 
              edge.target().id() === currentNode.id() && 
              ['has_version', 'owns'].includes(edge.data('label'))
            );
            
            // Traverse upward through these edges
            upwardEdges.forEach(edge => {
              const sourceNode = edge.source();
              traverseUpward(sourceNode, visited);
            });
          }
          
          // Find environments and resources chain (downward traversal)
          // Common relationships going down: deploy, uses, instance_of
          function traverseDownward(currentNode, visited = new Set()) {
            // Avoid cycles
            if (visited.has(currentNode.id())) return;
            visited.add(currentNode.id());
            
            // Add this node to the collection
            nodesToHighlight.merge(currentNode);
            
            // Find outgoing edges with relevant relationships
            const downwardEdges = currentNode.connectedEdges().filter(edge => 
              edge.source().id() === currentNode.id() && 
              ['deploy', 'uses', 'instance_of'].includes(edge.data('label'))
            );
            
            // Traverse downward through these edges
            downwardEdges.forEach(edge => {
              const targetNode = edge.target();
              traverseDownward(targetNode, visited);
            });
          }
          
          // Start traversal from the selected node in both directions
          traverseUpward(startNode);
          traverseDownward(startNode);
          
          return nodesToHighlight;
        }
        
        // Node tap event
        cy.on('tap', 'node', function(evt) {
          const node = evt.target;
          
          // Get all nodes to highlight based on current mode
          let nodesToShow;
          
          if (enableChainHighlight) {
            // Find all connected nodes in the chain
            const chainNodes = findConnectedNodesInChain(node);
            
            // Also include direct neighbors for completeness
            const directNeighbors = node.neighborhood('node');
            chainNodes.merge(directNeighbors);
            
            nodesToShow = chainNodes;
          } else {
            // Only show direct neighbors in simple mode
            nodesToShow = node.neighborhood('node').union(node);
          }
          
          // Gray out unrelated nodes
          cy.nodes().addClass('faded');
          
          // Remove faded class from nodes to show
          nodesToShow.removeClass('faded');
          
          // Find all edges between the nodes we want to show
          const relatedEdges = nodesToShow.edgesWith(nodesToShow);
          relatedEdges.removeClass('faded');
          
          // Remove any existing highlighting classes
          cy.elements().removeClass('highlighted highlighted-edge chain-node chain-edge');
          
          // Always highlight the selected node
          node.addClass('highlighted');
          
          if (enableChainHighlight) {
            // Add special styling to the chain nodes and edges
            nodesToShow.difference(node).addClass('chain-node');
            relatedEdges.addClass('chain-edge');
          }
          
          // Highlight direct connections with a stronger highlight
          node.connectedEdges().addClass('highlighted-edge');
          
          // Store reference to selected node
          selectedNode = node;
          
          // Show node details
          renderNodeDetails(node);
          
          // Also update the relations view
          updateRelationsView(node);
          
          // No notification for node selection
        });
        
        // Edge tap event
        cy.on('tap', 'edge', function(evt) {
          const edge = evt.target;
          
          // Clear any existing highlighting classes
          cy.elements().removeClass('highlighted highlighted-edge chain-node chain-edge faded hover-faded');
          
          // Highlight the selected edge
          edge.addClass('highlighted-edge');
          
          // Also highlight the connected nodes
          const sourceNode = edge.source();
          const targetNode = edge.target();
          sourceNode.addClass('highlighted');
          targetNode.addClass('highlighted');
          
          // Store reference to selected edge
          selectedEdge = edge;
          selectedNode = null; // Clear node selection
          
          // Show edge details
          renderEdgeDetails(edge);
          
          // Clear relations view since it's node-specific
          const relationsEl = document.getElementById('relations-content');
          relationsEl.innerHTML = `
            <div class="empty-state">
              <i class="fa-solid fa-circle-info"></i>
              <p>Relations view is only available for nodes</p>
            </div>
          `;
          
          // No notification for edge selection
        });

        // Tap on background (canvas)
        cy.on('tap', function(evt) {
          if (evt.target === cy) {
            // Clear all highlight, chain, and faded classes
            cy.elements().removeClass('highlighted highlighted-edge faded chain-node chain-edge hover-faded');
            
            // Reset selected references
            selectedNode = null;
            selectedEdge = null;
            
            // Clear details panel
            showEmptyDetails();
          }
        });
        
        // Mouseover node
        cy.on('mouseover', 'node', function(evt) {
          const node = evt.target;
          node.addClass('highlighted');
          
          // If the node is faded, temporarily reduce the fading effect when hovering
          if (node.hasClass('faded')) {
            node.addClass('hover-faded');
          }
        });
        
        // Mouseout node
        cy.on('mouseout', 'node', function(evt) {
          const node = evt.target;
          if (!node.selected()) {
            node.removeClass('highlighted');
          }
          
          // Remove hover-faded class if it exists
          node.removeClass('hover-faded');
        });
        
        // Mouseover edge
        cy.on('mouseover', 'edge', function(evt) {
          evt.target.addClass('highlighted-edge');
        });
        
        // Mouseout edge
        cy.on('mouseout', 'edge', function(evt) {
          if (!evt.target.selected()) {
            evt.target.removeClass('highlighted-edge');
          }
        });
      })
      .catch(err => {
        console.error('Error loading graph:', err);
        document.querySelector('.loading-overlay').style.display = 'none';
        
        // Create a more user-friendly error message
        const errorMessage = err.message || String(err);
        
        // Try to diagnose the specific issue
        let troubleshootingSteps = '';
        if (errorMessage.includes('Failed to fetch')) {
          troubleshootingSteps = `
            <ul style="text-align: left; padding-left: 20px; margin-top: 10px;">
              <li>Check that the API server is running and accessible.</li>
              <li>Make sure you're not experiencing network connectivity issues.</li>
              <li>Check for any CORS restrictions in your browser console.</li>
            </ul>
          `;
        } else if (errorMessage.includes('Invalid graph data format') || 
                  errorMessage.includes('Unexpected token') ||
                  errorMessage.includes('JSON')) {
          troubleshootingSteps = `
            <ul style="text-align: left; padding-left: 20px; margin-top: 10px;">
              <li>The API response format may have changed - check browser console.</li>
              <li>Try using the classic view and comparing the response.</li>
              <li>Ensure the API endpoint is returning valid JSON data.</li>
            </ul>
          `;
        } else {
          troubleshootingSteps = `
            <ul style="text-align: left; padding-left: 20px; margin-top: 10px;">
              <li>Please check the browser console (F12) for more detailed error information.</li>
              <li>Try running the classic view to see if that works.</li>
              <li>Try refreshing the page or clearing browser cache.</li>
            </ul>
          `;
        }
        
        // Add debug information button that logs to console when clicked
        const debugInfo = {
          timestamp: new Date().toISOString(),
          error: errorMessage,
          userAgent: navigator.userAgent,
        };
            
        document.getElementById('graph').innerHTML = 
          `<div class="empty-state" style="color: #e53e3e; max-width: 500px; margin: 0 auto; text-align: center; padding-top: 50px;">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p style="font-size: 1.2rem; font-weight: 500; margin-bottom: 1rem;">Failed to load graph</p>
            <p style="margin-bottom: 0.5rem;">${errorMessage}</p>
            
            <div style="font-size: 0.9rem; color: #718096; margin-top: 15px;">
              <p style="font-weight: 500; margin-bottom: 5px;">Troubleshooting:</p>
              ${troubleshootingSteps}
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button class="btn" onclick="window.location.reload()">
                <i class="fa-solid fa-rotate-right"></i> Retry
              </button>
              <button class="btn" onclick="window.location.href='/graph.html'">
                <i class="fa-solid fa-arrow-right"></i> Try Classic View
              </button>
              <button class="btn" onclick="console.log('Debug info:', ${JSON.stringify(debugInfo)}); alert('Debug info logged to console');">
                <i class="fa-solid fa-bug"></i> Debug Info
              </button>
            </div>
          </div>`;
      });

    // Real-time Logs WebSocket Client
    class LogsManager {
      constructor() {
        this.ws = null;
        this.isConnected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;
        this.logs = [];
        this.isVisible = true;
        
        this.initializeElements();
        this.setupEventListeners();
      }
      
      initializeElements() {
        this.connectionStatus = document.getElementById('connectionStatus');
        this.statusDot = this.connectionStatus.querySelector('.status-dot');
        this.statusText = this.connectionStatus.querySelector('.status-text');
        this.toggleConnect = document.getElementById('toggleConnect');
        this.clearLogs = document.getElementById('clearLogs');
        this.toggleLogs = document.getElementById('toggleLogs');
        this.logsFilters = document.getElementById('logsFilters');
        this.logsContent = document.getElementById('logsContent');
        this.logsEmpty = document.getElementById('logsEmpty');
        this.logsList = document.getElementById('logsList');
        this.logLevelFilter = document.getElementById('logLevelFilter');
        this.logEventTypeFilter = document.getElementById('logEventTypeFilter');
        this.logComponentFilter = document.getElementById('logComponentFilter');
        this.logSearchFilter = document.getElementById('logSearchFilter');
      }
      
      setupEventListeners() {
        this.toggleConnect.addEventListener('click', () => {
          if (this.isConnected) {
            this.disconnect();
          } else {
            this.connect();
          }
        });
        
        this.clearLogs.addEventListener('click', () => {
          this.clearAllLogs();
        });
        
        this.toggleLogs.addEventListener('click', () => {
          this.toggleLogsVisibility();
        });
        
        // Filter event listeners
        this.logLevelFilter.addEventListener('change', () => this.applyFilters());
        this.logEventTypeFilter.addEventListener('change', () => this.applyFilters());
        this.logComponentFilter.addEventListener('change', () => this.applyFilters());
        this.logSearchFilter.addEventListener('input', () => this.applyFilters());
      }
      
      connect() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          return;
        }
        
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/v1/logs/stream`;
          
          this.ws = new WebSocket(wsUrl);
          
          this.ws.onopen = () => {
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.updateConnectionStatus('connected', 'Connected');
            this.updateConnectButton('Disconnect', 'fa-plug-circle-xmark');
            this.addLogEntry('SUCCESS', 'WebSocket connected successfully', 'system');
          };
          
          this.ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              
              // Handle structured events with full event details
              if (data.type === 'event.structured' && data.event) {
                this.addStructuredEvent(data);
              } else {
                // Handle regular log entries
                this.addLogEntry(data.level, data.message, data.component, data.timestamp, data.details);
              }
            } catch (err) {
              console.error('Failed to parse log message:', err);
            }
          };
          
          this.ws.onclose = () => {
            this.isConnected = false;
            this.updateConnectionStatus('disconnected', 'Disconnected');
            this.updateConnectButton('Connect', 'fa-plug');
            this.addLogEntry('WARN', 'WebSocket connection closed', 'system');
            
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
              setTimeout(() => {
                this.reconnectAttempts++;
                this.addLogEntry('INFO', `Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`, 'system');
                this.connect();
              }, this.reconnectDelay * this.reconnectAttempts);
            }
          };
          
          this.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            this.addLogEntry('ERROR', 'WebSocket connection error', 'system');
          };
          
        } catch (err) {
          console.error('Failed to create WebSocket connection:', err);
          this.addLogEntry('ERROR', `Failed to connect: ${err.message}`, 'system');
        }
      }
      
      disconnect() {
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
        this.isConnected = false;
        this.updateConnectionStatus('disconnected', 'Disconnected');
        this.updateConnectButton('Connect', 'fa-plug');
        this.addLogEntry('INFO', 'Manually disconnected', 'system');
      }
      
      updateConnectionStatus(status, text) {
        this.statusDot.className = `status-dot ${status}`;
        this.statusText.textContent = text;
      }
      
      updateConnectButton(text, iconClass) {
        const icon = this.toggleConnect.querySelector('i');
        icon.className = `fa-solid ${iconClass}`;
        this.toggleConnect.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${text}`;
      }
      
      addLogEntry(level, message, component = '', timestamp = null, details = null) {
        const logEntry = {
          id: Date.now() + Math.random(),
          level: level,
          message: message,
          component: component,
          timestamp: timestamp || new Date().toISOString(),
          details: details,
          visible: true,
          type: 'log'
        };
        
        this.logs.unshift(logEntry);
        
        // Limit logs to 1000 entries
        if (this.logs.length > 1000) {
          this.logs = this.logs.slice(0, 1000);
        }
        
        this.renderLogs();
        this.scrollToTop();
      }

      addStructuredEvent(data) {
        const logEntry = {
          id: Date.now() + Math.random(),
          level: data.level || 'INFO',
          message: data.message,
          component: data.component,
          timestamp: data.timestamp || new Date().toISOString(),
          event_category: data.event_category || 'Other',
          event: data.event,
          visible: true,
          type: 'event'
        };
        
        this.logs.unshift(logEntry);
        
        // Limit logs to 1000 entries
        if (this.logs.length > 1000) {
          this.logs = this.logs.slice(0, 1000);
        }
        
        this.renderLogs();
        this.scrollToTop();
      }
      
      clearAllLogs() {
        this.logs = [];
        this.renderLogs();
      }
      
      applyFilters() {
        const levelFilter = this.logLevelFilter.value;
        const eventTypeFilter = this.logEventTypeFilter.value;
        const componentFilter = this.logComponentFilter.value;
        const searchFilter = this.logSearchFilter.value.toLowerCase();
        
        this.logs.forEach(log => {
          let visible = true;
          
          if (levelFilter && log.level !== levelFilter) {
            visible = false;
          }
          
          if (eventTypeFilter && !this.matchesEventType(log, eventTypeFilter)) {
            visible = false;
          }
          
          if (componentFilter && log.component !== componentFilter) {
            visible = false;
          }
          
          if (searchFilter && !log.message.toLowerCase().includes(searchFilter)) {
            visible = false;
          }
          
          log.visible = visible;
        });
        
        this.renderLogs();
      }

      matchesEventType(log, eventTypeFilter) {
        // Check event_category first for structured events
        if (log.event_category) {
          if (eventTypeFilter === log.event_category) return true;
          
          // Handle category groupings
          if (eventTypeFilter === 'Deployment' && 
              (log.event_category === 'Deployment' || log.message.includes('Deployment'))) {
            return true;
          }
          if (eventTypeFilter === 'Policy' && 
              (log.event_category === 'Policy' || log.message.includes('Policy'))) {
            return true;
          }
          if (eventTypeFilter === 'Resource' && 
              (log.event_category === 'Resource' || log.message.includes('Resource'))) {
            return true;
          }
          if (eventTypeFilter === 'Connection' && 
              (log.event_category === 'Connection' || log.message.includes('connected') || log.message.includes('Connected'))) {
            return true;
          }
        }
        
        // Fallback to message matching for regular logs
        const message = log.message.toLowerCase();
        switch (eventTypeFilter) {
          case 'Application Created':
            return message.includes('application created');
          case 'Application Updated':
            return message.includes('application updated');
          case 'Application Deleted':
            return message.includes('application deleted');
          case 'Deployment':
            return message.includes('deployment') || message.includes('deploy');
          case 'Policy':
            return message.includes('policy') || message.includes('transition');
          case 'Resource':
            return message.includes('resource') || message.includes('provision');
          case 'Connection':
            return message.includes('connect') || message.includes('websocket');
          default:
            return true;
        }
      }
      

      
      renderLogs() {
        const visibleLogs = this.logs.filter(log => log.visible);
        
        if (visibleLogs.length === 0) {
          this.logsEmpty.style.display = 'flex';
          this.logsList.style.display = 'none';
          this.logsEmpty.innerHTML = `
            <i class="fa-solid fa-circle-info"></i>
            <p>${this.logs.length === 0 ? 'No logs yet' : 'No logs match current filters'}</p>
          `;
          return;
        }
        
        this.logsEmpty.style.display = 'none';
        this.logsList.style.display = 'block';
        
        this.logsList.innerHTML = visibleLogs.map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          const componentTag = log.component ? `<span class="log-component">${log.component}</span>` : '';
          
          // Enhanced rendering for structured events
          if (log.type === 'event' && log.event) {
            const eventTypeTag = log.event_category ? `<span class="log-event-type ${log.event_category.toLowerCase().replace(/\s+/g, '-')}">${log.event_category}</span>` : '';
            const hasDetails = log.event && (log.event.payload || log.event.source !== log.component);
            
            return `
              <div class="log-entry log-${log.level.toLowerCase()} ${hasDetails ? 'log-expandable' : ''}" 
                   data-log-id="${log.id}" ${hasDetails ? 'onclick="logsManager.toggleLogDetails(this)"' : ''}>
                <div class="log-header">
                  <span class="log-level">${log.level}</span>
                  ${eventTypeTag}
                  ${componentTag}
                  <span class="log-time">${time}</span>
                  ${hasDetails ? '<i class="fa-solid fa-chevron-down log-expand-icon"></i>' : ''}
                </div>
                <div class="log-message">${this.escapeHtml(log.message)}</div>
                ${hasDetails ? `
                <div class="log-details" style="display: none;">
                  <div class="log-details-content">
                    <div class="log-detail-section">
                      <h4>Event Details</h4>
                      <div class="log-detail-grid">
                        <div class="log-detail-item">
                          <span class="log-detail-key">Type</span>
                          <span class="log-detail-value">${this.escapeHtml(log.event.type || 'N/A')}</span>
                        </div>
                        <div class="log-detail-item">
                          <span class="log-detail-key">Source</span>
                          <span class="log-detail-value">${this.escapeHtml(log.event.source || 'N/A')}</span>
                        </div>
                        <div class="log-detail-item">
                          <span class="log-detail-key">Subject</span>
                          <span class="log-detail-value">${this.escapeHtml(log.event.subject || 'N/A')}</span>
                        </div>
                      </div>
                    </div>
                    ${log.event.payload && Object.keys(log.event.payload).length > 0 ? `
                    <div class="log-detail-section">
                      <h4>Payload</h4>
                      <div class="log-payload">
                        <pre>${this.escapeHtml(JSON.stringify(log.event.payload, null, 2))}</pre>
                      </div>
                    </div>
                    ` : ''}
                  </div>
                </div>
                ` : ''}
              </div>
            `;
          } else {
            // Regular log entry
            return `
              <div class="log-entry log-${log.level.toLowerCase()}">
                <div class="log-header">
                  <span class="log-level">${log.level}</span>
                  ${componentTag}
                  <span class="log-time">${time}</span>
                </div>
                <div class="log-message">${this.escapeHtml(log.message)}</div>
              </div>
            `;
          }
        }).join('');
      }
      
      toggleLogsVisibility() {
        this.isVisible = !this.isVisible;
        const icon = this.toggleLogs.querySelector('i');
        
        if (this.isVisible) {
          this.logsFilters.style.display = 'flex';
          this.logsContent.style.display = 'block';
          icon.className = 'fa-solid fa-chevron-up';
        } else {
          this.logsFilters.style.display = 'none';
          this.logsContent.style.display = 'none';
          icon.className = 'fa-solid fa-chevron-down';
        }
      }
      
      scrollToTop() {
        if (this.logsList.firstChild) {
          this.logsList.scrollTop = 0;
        }
      }
      
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      toggleLogDetails(element) {
        const details = element.querySelector('.log-details');
        const icon = element.querySelector('.log-expand-icon');
        
        if (details.style.display === 'none') {
          details.style.display = 'block';
          icon.className = 'fa-solid fa-chevron-up log-expand-icon';
          element.classList.add('log-expanded');
        } else {
          details.style.display = 'none';
          icon.className = 'fa-solid fa-chevron-down log-expand-icon';
          element.classList.remove('log-expanded');
        }
      }
    }
    
    // Initialize logs manager
    const logsManager = new LogsManager();
    
    // Auto-connect on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        logsManager.connect();
      }, 1000);
    });
  </script>
</body>
</html>
